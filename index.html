<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PJ Official – Under Maintenance</title>

  <!-- EmailJS client (global) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body style="margin:0;min-height:100vh;background:#000;color:#fff;font-family:Arial, Helvetica, sans-serif;display:flex;align-items:center;justify-content:center;text-align:center;">

  <div style="width:380px;padding:26px;position:relative;">

    <!-- animated gears -->
    <div style="position:relative;height:120px;margin-bottom:22px;">
      <div class="gear big">⚙️</div>
      <div class="gear mid">⚙️</div>
      <div class="gear small">⚙️</div>
    </div>

    <h2 style="margin:0 0 8px 0">PJ official website is under update</h2>
    <p style="color:#bdbdbd;font-size:14px;margin:0 0 18px 0">Enter your email to get notified once the website is live.</p>

    <!-- Email input (users) -->
    <input id="emailInput" type="text" placeholder="Enter your email (example: someone@example.com)" 
      style="width:100%;padding:12px;border-radius:8px;border:none;outline:none;font-size:14px;background:#111;color:#fff;" />

    <!-- Password input (admins) - hidden by default -->
    <input id="passwordInput" type="password" placeholder="(Admin only) Enter admin password"
      style="width:100%;padding:12px;border-radius:8px;border:none;outline:none;font-size:14px;background:#111;color:#fff;margin-top:10px;display:none;" />

    <button id="continueBtn" style="margin-top:16px;width:100%;padding:12px;border:none;border-radius:30px;background:#ff7a00;color:#000;font-weight:700;cursor:pointer;font-size:14px;">
      Continue
    </button>

    <p id="userMsg" style="font-size:13px;margin-top:12px;color:#ccc;min-height:18px;"></p>

    <!-- ADMIN PANEL (hidden by default) -->
    <div id="adminPanel" style="display:none;margin-top:20px;text-align:center;">
      <div style="display:flex;align-items:center;gap:10px;justify-content:flex-start;">
        <button id="backBtn" title="Back" style="background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer;padding:6px 0;margin-right:auto;">←</button>
        <div style="flex:1"></div>
      </div>

      <h3 style="color:#ff7a00;margin:10px 0 6px 0;">Admin Panel</h3>
      <p style="color:#bdbdbd;font-size:13px;margin:0 0 12px 0;">Click <strong>DONE</strong> to send the update email to all saved accounts.</p>

      <button id="doneBtn" style="margin-top:8px;width:100%;padding:12px;border:none;border-radius:30px;background:#ff7a00;color:#000;font-weight:700;cursor:pointer;font-size:14px;">
        DONE — Send Update Email
      </button>

      <p id="adminStatus" style="font-size:13px;margin-top:12px;color:#ccc;min-height:18px;"></p>
    </div>

  </div>

<script type="module">
import { db } from "./firebase.js";
import {
  collection,
  addDoc,
  getDocs,
  query,
  where,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* CONFIG */
const ADMIN_PASSWORD = "sonu@jeet";
const EMAILJS_PUBLIC_KEY = "EevqJ2-cX2wrZXXJO";
const EMAILJS_SERVICE = "service_4mpzhc6";
const EMAILJS_TEMPLATE = "template_b2flto4";

/* small helpers */
function showUserMessage(text, color="#ccc"){
  const el = document.getElementById("userMsg");
  el.innerText = text;
  el.style.color = color;
}
function showAdminStatus(text, color="#ccc"){
  const el = document.getElementById("adminStatus");
  el.innerText = text;
  el.style.color = color;
}
function isLikelyEmail(s){
  if(!s) return false;
  return s.trim().toLowerCase().endsWith(".com");
}

/* wait DOM */
document.addEventListener("DOMContentLoaded", async () => {

  // initialize EmailJS (global script)
  let tries = 0;
  while (typeof window.emailjs === "undefined" && tries < 20) {
    await new Promise(res => setTimeout(res, 100));
    tries++;
  }
  if (typeof window.emailjs !== "undefined") {
    try { window.emailjs.init(EMAILJS_PUBLIC_KEY); } catch(e){ console.warn("EmailJS init err", e); }
  }

  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const continueBtn = document.getElementById("continueBtn");
  const adminPanel = document.getElementById("adminPanel");
  const doneBtn = document.getElementById("doneBtn");
  const backBtn = document.getElementById("backBtn");

  /* reveal admin password input: double-click email input */
  emailInput.addEventListener("dblclick", () => {
    passwordInput.style.display = "block";
    passwordInput.focus();
    showUserMessage("Admin mode visible (secret)", "#ff7a00");
  });

  /* CONTINUE button */
  continueBtn.addEventListener("click", async () => {
    showUserMessage("");
    const val = emailInput.value.trim();
    const pass = passwordInput.value.trim();

    // ADMIN: if password entered and correct, open admin panel immediately (no save)
    if (pass.length > 0) {
      if (pass === ADMIN_PASSWORD) {
        adminPanel.style.display = "block";
        showUserMessage("Admin access granted", "#00ff99");
        // clear inputs (do not save)
        emailInput.value = "";
        passwordInput.value = "";
      } else {
        showUserMessage("Wrong admin password", "red");
      }
      return;
    }

    // USER: save email (validate)
    if (!isLikelyEmail(val)) {
      showUserMessage("Enter valid email (must end with .com)", "orange");
      return;
    }

    try {
      const q = query(collection(db, "notifyEmails"), where("email", "==", val));
      const snap = await getDocs(q);
      if (!snap.empty) {
        showUserMessage("This email already saved", "orange");
        return;
      }

      await addDoc(collection(db, "notifyEmails"), {
        email: val,
        notified: false,
        createdAt: Date.now()
      });

      // optional immediate confirmation (can be left or removed)
      if (typeof window.emailjs !== "undefined") {
        try {
          await window.emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, { to_email: val });
        } catch(e) {
          console.warn("Immediate confirmation failed:", e);
        }
      }

      showUserMessage("Email saved successfully", "#00ff99");
      emailInput.value = "";

    } catch (err) {
      console.error("Save email failed:", err);
      showUserMessage("Unable to save email. Try again.", "red");
    }
  });

  /* BACK button */
  backBtn.addEventListener("click", () => {
    adminPanel.style.display = "none";
    showUserMessage("Returned from admin panel", "#ccc");
    showAdminStatus("", "#ccc");
  });

  /* DONE: send to all unnotified users with delay + update notified flag */
  doneBtn.addEventListener("click", async () => {
    showAdminStatus("Preparing to send emails...", "#ccc");

    try {
      const snap = await getDocs(collection(db, "notifyEmails"));
      let sentCount = 0;

      function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

      for (const d of snap.docs) {
        const data = d.data();
        if (data.notified === true) continue;

        if (typeof window.emailjs === "undefined") {
          throw new Error("EmailJS not loaded");
        }

        try {
          await window.emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, { to_email: data.email });
          // mark notified true
          await updateDoc(doc(db, "notifyEmails", d.id), { notified: true });
          sentCount++;
          console.log("Sent to:", data.email);
        } catch (sendErr) {
          console.error("Failed to send to:", data.email, sendErr);
          // continue without marking notified
        }

        // delay to reduce block risk
        await sleep(2000);
      }

      showAdminStatus(`Completed. ${sentCount} emails sent.`, "#00ff99");

    } catch (err) {
      console.error("Error sending update emails:", err);
      showAdminStatus("Error sending emails — check console or EmailJS settings.", "red");
    }
  });

}); // end DOMContentLoaded
</script>

<style>
/* gears styling & animation */
.gear { position:absolute; color:#ff7a00; display:flex; align-items:center; justify-content:center; }
.big { font-size:88px; left:50%; top:50%; transform:translate(-50%,-50%); animation:spin 5s linear infinite; }
.mid { font-size:56px; left:68%; top:36%; animation:spinReverse 3s linear infinite; }
.small { font-size:36px; left:34%; top:30%; animation:spin 2s linear infinite; }
@keyframes spin { from { transform:translate(-50%,-50%) rotate(0deg); } to { transform:translate(-50%,-50%) rotate(360deg); } }
@keyframes spinReverse { from { transform:rotate(360deg);} to { transform:rotate(0);} }
input { box-sizing:border-box; }
@media (max-width:420px) { body > div { width:92% !important; } }
</style>
</body>
</html>

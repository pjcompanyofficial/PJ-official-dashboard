<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PJ Official Dashboard | Ultimate Security</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --black: #0a0a0a;
            --dark-grey: #121212;
            --orange: #ff7a00;
            --border: #222;
            --text-main: #ffffff;
            --red: #ff3b3b;
            --green: #00ff00;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--black);
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        /* Header */
        .header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; background: var(--black); z-index: 100;
        }

        .plus-btn {
            font-size: 28px; color: var(--orange); cursor: pointer;
            width: 45px; height: 45px; border: 2px solid var(--orange);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }

        /* Gallery Grid */
        .cii-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 15px; padding: 20px;
        }

        .cii-card {
            background: var(--dark-grey); border-radius: 12px;
            overflow: hidden; border: 1px solid var(--border); position: relative;
        }

        .cii-card img { width: 100%; height: 160px; object-fit: cover; pointer-events: none; }
        .cii-info { padding: 10px; font-size: 13px; text-align: center; font-weight: 600; }

        /* Selection Overlay */
        .select-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 60; cursor: pointer; display: none;
        }
        .select-dot {
            position: absolute; top: 10px; right: 10px;
            width: 28px; height: 28px; border: 2px solid var(--orange);
            border-radius: 6px; background: rgba(0,0,0,0.8);
            z-index: 70; display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: white; transition: 0.2s;
        }
        .cii-card.selected-item { border: 2px solid var(--orange); }
        .cii-card.selected-item .select-dot { background: var(--orange); }
        .cii-card.selected-item .select-dot::after { content: '✓'; }

        /* Danger Section */
        .danger-section {
            margin: 40px 20px; padding: 25px;
            border: 2px dashed var(--red); border-radius: 20px; text-align: center;
        }

        #dangerHold {
            background: var(--red); color: white; border: none;
            padding: 16px 32px; border-radius: 12px; font-weight: bold;
            width: 100%; font-size: 16px; transition: 0.1s;
        }

        /* Screens */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--black); z-index: 1000; padding: 25px;
            box-sizing: border-box; overflow-y: auto;
        }

        /* Loader Animation */
        #waterBg {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: rgba(255, 122, 0, 0.25); z-index: -1; transition: height 0.4s linear;
        }

        .loader-ring {
            width: 180px; height: 180px; border-radius: 50%;
            border: 8px solid #1a1a1a; border-top: 8px solid var(--orange);
            display: flex; align-items: center; justify-content: center;
            animation: rotate 2s linear infinite; position: relative;
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        .percent-box { position: absolute; font-size: 32px; font-weight: 700; color: var(--orange); }

        /* Form styling */
        .standard-input {
            width: 100%; padding: 15px; background: #111; border: 1px solid #333;
            color: white; border-radius: 10px; margin-bottom: 20px; font-size: 16px;
        }
        .btn-action {
            width: 100%; padding: 18px; border-radius: 12px; border: none;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }
        .btn-orange { background: var(--orange); color: white; }
    </style>
</head>
<body>

    <!-- GALLERY VIEW -->
    <div id="galleryView">
        <div class="header">
            <h2 style="color: var(--orange); margin: 0;">C II ASSETS</h2>
            <div id="plusBtn" class="plus-btn">+</div>
        </div>

        <div id="galleryGrid" class="cii-grid">
            <!-- Items added via JS -->
        </div>

        <div class="danger-section">
            <p style="color: var(--red); font-size: 13px; font-weight: 600;">DANGER ZONE</p>
            <button id="dangerHold">HOLD 5s TO UNLOCK DELETE</button>
        </div>
    </div>

    <!-- ADD PANEL -->
    <div id="addScreen" class="screen hidden">
        <h2 style="color: var(--orange);">Naya Asset Add Karein</h2>
        <input type="file" id="fileInput" class="standard-input">
        <input type="text" id="titleInput" placeholder="Asset ka naam likhein..." class="standard-input">
        <button id="saveBtn" class="btn-action btn-orange">CLOUD MEIN SAVE KAREIN</button>
        <button onclick="hideScreen('addScreen')" class="btn-action" style="background:none; color:#555; margin-top:10px;">CANCEL</button>
    </div>

    <!-- REASON SCREEN -->
    <div id="reasonScreen" class="screen hidden">
        <h2 style="color: var(--orange); text-align:center;">Deletion Ka Karan</h2>
        <div id="reasonsContainer"></div>
        <button id="reasonNext" class="btn-action btn-orange hidden">CONTINUE TO OTP</button>
    </div>

    <!-- OTP SCREEN -->
    <div id="otpScreen" class="screen hidden" style="text-align:center;">
        <h2>Security Check</h2>
        <p style="color:#777;">OTP email par bhej diya gaya hai.</p>
        <input type="number" id="otpBox" class="standard-input" style="font-size:30px; letter-spacing:8px; text-align:center;" placeholder="000000">
        <div id="otpFeedback" style="margin-bottom:20px;"></div>
        <button id="verifyBtn" class="btn-action btn-orange">VERIFY OTP</button>
    </div>

    <!-- FINAL ANIMATION SCREEN -->
    <div id="animScreen" class="screen hidden" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div id="waterBg"></div>
        <div style="position:relative; display:flex; align-items:center; justify-content:center;">
            <div class="loader-ring"></div>
            <div id="percentLabel" class="percent-box">0%</div>
        </div>
        <h3 id="deletingTitle" style="margin-top:40px; color:var(--orange);">Deleting...</h3>
        <button id="stopDelete" class="btn-action" style="background:var(--red); color:white; width:auto; padding:10px 40px; margin-top:30px;">STOP</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYCMvd3MLf4oYIzlLqJ5KjzwvJrMF0t4",
            authDomain: "pj-official-dashboard.firebaseapp.com",
            projectId: "pj-official-dashboard",
            storageBucket: "pj-official-dashboard.firebasestorage.app",
            messagingSenderId: "929357284971",
            appId: "1:929357284971:web:2fd68f9f8f87c3a8d2137a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        emailjs.init("EevqJ2-cX2wrZXXJO");

        let deleteMode = false;
        let selectedItems = [];
        let holdTimer;
        let authOTP = null;
        let activeReason = "";
        let deletionActive = false;

        // --- Gallery Loader ---
        async function loadGallery() {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = "<p style='grid-column: span 2; text-align:center;'>Assets Fetch Ho Rahe Hain...</p>";
            
            try {
                // Fetch assets ordered by time (newest first)
                const snapshot = await getDocs(collection(db, "cii"));
                grid.innerHTML = "";
                
                snapshot.forEach((snap) => {
                    const data = snap.data();
                    const item = { id: snap.id, ...data };

                    const card = document.createElement('div');
                    card.className = "cii-card";
                    card.innerHTML = `
                        <img src="${data.url}">
                        <div class="cii-info">${data.title}</div>
                        <div class="select-dot"></div>
                        <div class="select-overlay" style="display: ${deleteMode ? 'block' : 'none'}"></div>
                    `;

                    const overlay = card.querySelector('.select-overlay');
                    overlay.onclick = () => {
                        const isSelected = card.classList.toggle('selected-item');
                        if (isSelected) selectedItems.push(item);
                        else selectedItems = selectedItems.filter(i => i.id !== item.id);
                    };

                    grid.appendChild(card);
                });
            } catch (err) {
                grid.innerHTML = "<p>Data Loading Failed.</p>";
            }
        }

        // --- Save Asset (With Auto Redirect Fix) ---
        document.getElementById('saveBtn').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            const title = document.getElementById('titleInput').value;
            
            if (!file || !title) return alert("Pehle file select karein aur title likhein!");

            const btn = document.getElementById('saveBtn');
            btn.innerText = "UPLOADING..."; btn.disabled = true;

            try {
                const filePath = `cii/${Date.now()}_${file.name}`;
                const sRef = ref(storage, filePath);
                
                // 1. Upload to Storage
                await uploadBytes(sRef, file);
                const url = await getDownloadURL(sRef);

                // 2. Save to Firestore
                await addDoc(collection(db, "cii"), {
                    title: title,
                    url: url,
                    path: filePath,
                    createdAt: Date.now()
                });

                // --- FIX: Auto Redirect aur Reset ---
                alert("Naya Asset CII Page par add ho gaya!");
                
                // Form saaf karein
                document.getElementById('fileInput').value = "";
                document.getElementById('titleInput').value = "";
                
                // Add Screen band karein aur Gallery dikhayein
                hideScreen('addScreen');
                loadGallery(); // Gallery turant update ho jayegi
                
                btn.innerText = "CLOUD MEIN SAVE KAREIN"; btn.disabled = false;

            } catch (e) {
                alert("Upload failed: " + e.message);
                btn.innerText = "SAVE AGAIN"; btn.disabled = false;
            }
        };

        // --- Danger Hold Trigger ---
        const holdBtn = document.getElementById('dangerHold');
        const startHold = () => {
            holdTimer = setTimeout(() => {
                deleteMode = true;
                selectedItems = [];
                alert("DELETE MODE ON: Images select karein aur upar '→' par click karein.");
                document.getElementById('plusBtn').innerText = "→";
                loadGallery();
            }, 5000);
        };
        const cancelHold = () => clearTimeout(holdTimer);

        holdBtn.onmousedown = startHold; holdBtn.onmouseup = cancelHold;
        holdBtn.ontouchstart = startHold; holdBtn.ontouchend = cancelHold;

        // --- UI Buttons ---
        document.getElementById('plusBtn').onclick = () => {
            if (!deleteMode) {
                document.getElementById('addScreen').classList.remove('hidden');
            } else {
                if (selectedItems.length === 0) return alert("Kuch toh select karein!");
                showReasonScreen();
            }
        };

        const reasons = [
            "Maine galti se upload kar diya", "Picture galat hai", "Duplicate entry",
            "Data purana ho gaya", "Quality achhi nahi hai", "Galat category",
            "Security reasons", "Testing complete", "Owner's order", "Image corrupted",
            "Employee error", "Information update", "Internal management", "Wrong title",
            "Quality failed", "Experimental", "Legal issue"
        ];

        function showReasonScreen() {
            hideScreen('galleryView');
            document.getElementById('reasonScreen').classList.remove('hidden');
            const box = document.getElementById('reasonsContainer');
            box.innerHTML = "";
            reasons.forEach(r => {
                const div = document.createElement('div');
                div.className = "reason-card";
                div.innerHTML = `<span>${r}</span> <div class="reason-circle"></div>`;
                div.onclick = () => {
                    document.querySelectorAll('.reason-card').forEach(c => c.classList.remove('active'));
                    div.classList.add('active');
                    activeReason = r;
                    document.getElementById('reasonNext').classList.remove('hidden');
                };
                box.appendChild(div);
            });
        }

        document.getElementById('reasonNext').onclick = async () => {
            authOTP = Math.floor(100000 + Math.random() * 900000);
            try {
                await emailjs.send("Service_4mpzhc6", "template_1rgmrr5", {
                    otp_code: authOTP,
                    reason: activeReason,
                    to_email: "parijat180chakraborty@gmail.com"
                });
                hideScreen('reasonScreen');
                document.getElementById('otpScreen').classList.remove('hidden');
            } catch (e) { alert("OTP Send Failed!"); }
        };

        document.getElementById('verifyBtn').onclick = () => {
            if (document.getElementById('otpBox').value == authOTP) {
                initiateDeletion();
            } else {
                alert("OTP galat hai!");
            }
        };

        async function initiateDeletion() {
            hideScreen('otpScreen');
            document.getElementById('animScreen').classList.remove('hidden');
            deletionActive = true;

            for (let item of selectedItems) {
                if (!deletionActive) break;
                document.getElementById('deletingTitle').innerText = `Removing: ${item.title}`;
                let p = 0;
                await new Promise(res => {
                    const int = setInterval(() => {
                        if (!deletionActive) { clearInterval(int); res(); return; }
                        p++;
                        document.getElementById('percentLabel').innerText = p + "%";
                        document.getElementById('waterBg').style.height = p + "%";
                        if (p >= 100) { clearInterval(int); res(); }
                    }, 300);
                });

                if (deletionActive) {
                    await deleteDoc(doc(db, "cii", item.id));
                    if (item.path) {
                        try { await deleteObject(ref(storage, item.path)); } catch(e){}
                    }
                }
            }
            if (deletionActive) {
                alert("Deletion Successful!");
                location.reload();
            }
        }

        document.getElementById('stopDelete').onclick = () => {
            deletionActive = false;
            location.reload();
        };

        window.hideScreen = (id) => document.getElementById(id).classList.add('hidden');

        // Init App
        loadGallery();

    </script>
</body>
</html>


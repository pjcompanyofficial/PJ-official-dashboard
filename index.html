<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PJ Official Dashboard | Ultimate Security</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        :root {
            --black: #0a0a0a;
            --dark-grey: #121212;
            --orange: #ff7a00;
            --border: #222;
            --text-main: #ffffff;
            --red: #ff3b3b;
            --green: #00ff00;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: var(--black);
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .hidden { display: none !important; }

        /* Header */
        .header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            position: sticky; top: 0; background: var(--black); z-index: 100;
        }

        .plus-btn {
            font-size: 28px; color: var(--orange); cursor: pointer;
            width: 45px; height: 45px; border: 2px solid var(--orange);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: 0.3s;
        }

        /* Gallery Grid */
        .cii-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 15px; padding: 20px;
        }

        .cii-card {
            background: var(--dark-grey); border-radius: 12px;
            overflow: hidden; border: 1px solid var(--border); position: relative;
        }

        .cii-card img { width: 100%; height: 160px; object-fit: cover; }
        .cii-info { padding: 10px; font-size: 13px; text-align: center; font-weight: 600; }

        /* Selection Box Styling */
        .select-dot {
            position: absolute; top: 8px; right: 8px;
            width: 26px; height: 26px; border: 2px solid var(--orange);
            border-radius: 6px; background: rgba(0,0,0,0.7);
            z-index: 50; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 16px; color: white;
        }
        .select-dot.selected { background: var(--orange); }
        .select-dot.selected::after { content: '✓'; }

        /* Danger Zone */
        .danger-section {
            margin: 40px 20px; padding: 25px;
            border: 2px dashed var(--red); border-radius: 20px; text-align: center;
        }

        #dangerHold {
            background: var(--red); color: white; border: none;
            padding: 16px 32px; border-radius: 12px; font-weight: bold;
            width: 100%; font-size: 16px; transition: 0.1s;
        }

        /* Screens */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--black); z-index: 1000; padding: 25px;
            box-sizing: border-box; overflow-y: auto;
        }

        /* Reasons */
        .reason-card {
            padding: 18px; border: 1px solid var(--border);
            margin-bottom: 12px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            transition: 0.3s;
        }
        .reason-card.active { border-color: var(--green); background: rgba(0,255,0,0.05); }
        .reason-circle { width: 20px; height: 20px; border: 2px solid var(--orange); border-radius: 50%; }
        .reason-card.active .reason-circle { background: var(--green); border-color: var(--green); }

        /* Water Animation */
        #waterBg {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: rgba(255, 122, 0, 0.25); z-index: -1; transition: height 0.4s linear;
        }

        .loader-ring {
            width: 180px; height: 180px; border-radius: 50%;
            border: 8px solid #1a1a1a; border-top: 8px solid var(--orange);
            display: flex; align-items: center; justify-content: center;
            animation: rotate 2s linear infinite; position: relative;
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        .percent-box { position: absolute; font-size: 32px; font-weight: 700; color: var(--orange); }

        /* Inputs */
        .standard-input {
            width: 100%; padding: 15px; background: #111; border: 1px solid #333;
            color: white; border-radius: 10px; margin-bottom: 20px; font-size: 16px;
        }

        .btn-action {
            width: 100%; padding: 18px; border-radius: 12px; border: none;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }
        .btn-orange { background: var(--orange); color: white; }
    </style>
</head>
<body>

    <!-- GALLERY VIEW -->
    <div id="galleryView">
        <div class="header">
            <h2 style="color: var(--orange); margin: 0;">C II ASSETS</h2>
            <div id="plusBtn" class="plus-btn">+</div>
        </div>

        <div id="galleryGrid" class="cii-grid">
            <!-- Items added by JS -->
        </div>

        <div class="danger-section">
            <p style="color: var(--red); font-size: 13px; font-weight: 600;">HIGH SECURITY AREA</p>
            <button id="dangerHold">HOLD 5s TO DELETE</button>
        </div>
    </div>

    <!-- ADD PANEL -->
    <div id="addScreen" class="screen hidden">
        <h2 style="color: var(--orange);">Naya Image Add Karein</h2>
        <input type="file" id="fileInput" class="standard-input">
        <input type="text" id="titleInput" placeholder="Image Title Likhein..." class="standard-input">
        <button id="saveBtn" class="btn-action btn-orange">CLOUD MEIN SAVE KAREIN</button>
        <button onclick="hideScreen('addScreen')" class="btn-action" style="background:none; color:#555;">WAPAS JAYEIN</button>
    </div>

    <!-- REASON SCREEN -->
    <div id="reasonScreen" class="screen hidden">
        <h2 style="color: var(--orange); text-align:center;">Deletion Ka Karan</h2>
        <div id="reasonsContainer"></div>
        <button id="reasonNext" class="btn-action btn-orange hidden">CONTINUE TO OTP</button>
    </div>

    <!-- OTP SCREEN -->
    <div id="otpScreen" class="screen hidden" style="text-align:center;">
        <h2>Security Verification</h2>
        <p style="color:#777; font-size:14px;">OTP parijat180chakraborty@gmail.com par bhej diya gaya hai.</p>
        <input type="number" id="otpBox" class="standard-input" style="font-size:30px; letter-spacing:8px; text-align:center;" placeholder="000000">
        <div id="otpFeedback" style="margin-bottom:20px; font-weight:bold;"></div>
        <button id="verifyBtn" class="btn-action btn-orange">OTP VERIFY KAREIN</button>
    </div>

    <!-- FINAL ANIMATION SCREEN -->
    <div id="animScreen" class="screen hidden" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div id="waterBg"></div>
        <div style="position:relative; display:flex; align-items:center; justify-content:center;">
            <div class="loader-ring"></div>
            <div id="percentLabel" class="percent-box">0%</div>
        </div>
        <h3 id="deletingTitle" style="margin-top:40px; color:var(--orange);">Processing...</h3>
        <button id="stopDelete" class="btn-action" style="background:var(--red); color:white; width:auto; padding:10px 40px; margin-top:30px;">STOP</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCYCMvd3MLf4oYIzlLqJ5KjzwvJrMF0t4",
            authDomain: "pj-official-dashboard.firebaseapp.com",
            projectId: "pj-official-dashboard",
            storageBucket: "pj-official-dashboard.firebasestorage.app",
            messagingSenderId: "929357284971",
            appId: "1:929357284971:web:2fd68f9f8f87c3a8d2137a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        emailjs.init("EevqJ2-cX2wrZXXJO");

        let deleteMode = false;
        let selectedData = [];
        let timer;
        let generatedOTP = null;
        let currentReason = "";
        let globalContinue = false;

        // --- LOAD GALLERY (Fixed Selection Box Logic) ---
        async function loadGallery() {
            const grid = document.getElementById('galleryGrid');
            grid.innerHTML = "<p style='grid-column: span 2; text-align:center;'>Loading Assets...</p>";
            
            const snapshot = await getDocs(collection(db, "cii"));
            grid.innerHTML = "";

            snapshot.forEach((snap) => {
                const data = snap.data();
                const item = { id: snap.id, ...data };

                const card = document.createElement('div');
                card.className = "cii-card";
                card.innerHTML = `
                    <img src="${data.url}">
                    <div class="cii-info">${data.title}</div>
                `;

                // Add Selection Box if Delete Mode is ON
                if (deleteMode) {
                    const dot = document.createElement('div');
                    dot.className = "select-dot";
                    dot.onclick = (e) => {
                        e.stopPropagation();
                        dot.classList.toggle('selected');
                        if (dot.classList.contains('selected')) {
                            selectedData.push(item);
                        } else {
                            selectedData = selectedData.filter(i => i.id !== item.id);
                        }
                    };
                    card.appendChild(dot);
                }

                grid.appendChild(card);
            });
        }

        // --- DANGER HOLD (5 Seconds) ---
        const dBtn = document.getElementById('dangerHold');
        const startH = () => {
            dBtn.style.transform = "scale(0.96)";
            timer = setTimeout(() => {
                deleteMode = true;
                selectedData = [];
                alert("DELETE MODE ACTIVE: Ab images select karke upar '→' par click karein.");
                document.getElementById('plusBtn').innerText = "→";
                loadGallery();
            }, 5000);
        };
        const endH = () => {
            clearTimeout(timer);
            dBtn.style.transform = "scale(1)";
        };

        dBtn.onmousedown = startH; dBtn.onmouseup = endH;
        dBtn.ontouchstart = startH; dBtn.ontouchend = endH;

        // --- PLUS BUTTON ACTION ---
        document.getElementById('plusBtn').onclick = () => {
            if (!deleteMode) {
                document.getElementById('addScreen').classList.remove('hidden');
            } else {
                if (selectedData.length === 0) return alert("Pehle images select karein!");
                openReasonScreen();
            }
        };

        // --- 17 REASONS ---
        const reasons = [
            "Maine galti se upload kar diya", "Picture galat hai, kuch aur hona tha",
            "Duplicate entry mil gayi", "Data purana ho gaya hai", "Resolution achhi nahi hai",
            "Galat category mein upload hua", "Security reasons", "Testing purpose complete",
            "Owner's direct order", "Image corrupted lag rahi hai", "Employee ne galti se dala",
            "Information update karni hai", "Internal storage management", "Wrong title mention kiya",
            "Quality checking failed", "Experimental upload tha", "Legal policy issue"
        ];

        function openReasonScreen() {
            document.getElementById('galleryView').classList.add('hidden');
            document.getElementById('reasonScreen').classList.remove('hidden');
            const cont = document.getElementById('reasonsContainer');
            cont.innerHTML = "";
            
            reasons.forEach(r => {
                const div = document.createElement('div');
                div.className = "reason-card";
                div.innerHTML = `<span>${r}</span> <div class="reason-circle"></div>`;
                div.onclick = () => {
                    document.querySelectorAll('.reason-card').forEach(c => c.classList.remove('active'));
                    div.classList.add('active');
                    currentReason = r;
                    document.getElementById('reasonNext').classList.remove('hidden');
                };
                cont.appendChild(div);
            });
        }

        document.getElementById('reasonNext').onclick = async () => {
            generatedOTP = Math.floor(100000 + Math.random() * 900000);
            try {
                await emailjs.send("Service_4mpzhc6", "template_1rgmrr5", {
                    otp_code: generatedOTP,
                    reason: currentReason,
                    to_email: "parijat180chakraborty@gmail.com"
                });
                hideScreen('reasonScreen');
                document.getElementById('otpScreen').classList.remove('hidden');
            } catch (e) { alert("OTP Send Error!"); }
        };

        // --- OTP VERIFY ---
        document.getElementById('verifyBtn').onclick = () => {
            const val = document.getElementById('otpBox').value;
            const box = document.getElementById('otpBox');
            const feed = document.getElementById('otpFeedback');

            if (val == generatedOTP) {
                box.style.borderColor = "var(--green)";
                feed.innerText = "Verification Success!";
                feed.style.color = "var(--green)";
                setTimeout(startFinalProcess, 1500);
            } else {
                box.style.borderColor = "var(--red)";
                feed.innerText = "Incorrect OTP!";
                feed.style.color = "var(--red)";
            }
        };

        // --- FINAL DELETION ANIMATION ---
        async function startFinalProcess() {
            hideScreen('otpScreen');
            document.getElementById('animScreen').classList.remove('hidden');
            globalContinue = true;

            for (let item of selectedData) {
                if (!globalContinue) break;
                document.getElementById('deletingTitle').innerText = `Deleting: ${item.title}`;
                
                let p = 0;
                await new Promise(res => {
                    const int = setInterval(() => {
                        if (!globalContinue) { clearInterval(int); res(); return; }
                        p++;
                        document.getElementById('percentLabel').innerText = p + "%";
                        document.getElementById('waterBg').style.height = p + "%";
                        if (p >= 100) { clearInterval(int); res(); }
                    }, 300); // 30s per image
                });

                if (globalContinue) {
                    await deleteDoc(doc(db, "cii", item.id));
                    if (item.path) {
                        try { await deleteObject(ref(storage, item.path)); } catch(e){}
                    }
                }
            }

            if (globalContinue) {
                alert("Selected data successfully deleted!");
                location.reload();
            }
        }

        document.getElementById('stopDelete').onclick = () => {
            globalContinue = false;
            alert("Process Stopped!");
            location.reload();
        };

        // --- SAVE FUNCTION ---
        document.getElementById('saveBtn').onclick = async () => {
            const file = document.getElementById('fileInput').files[0];
            const title = document.getElementById('titleInput').value;
            if (!file || !title) return alert("Dono cheezein bhariye!");

            const btn = document.getElementById('saveBtn');
            btn.innerText = "SAVING..."; btn.disabled = true;

            try {
                const fPath = `cii/${Date.now()}_${file.name}`;
                const sRef = ref(storage, fPath);
                await uploadBytes(sRef, file);
                const url = await getDownloadURL(sRef);

                await addDoc(collection(db, "cii"), {
                    title: title, url: url, path: fPath, time: Date.now()
                });

                alert("Successfully saved!");
                location.reload();
            } catch (e) {
                alert("Error: " + e.message);
                btn.innerText = "CLOUD MEIN SAVE KAREIN"; btn.disabled = false;
            }
        };

        window.hideScreen = (id) => document.getElementById(id).classList.add('hidden');

        // Start
        loadGallery();

    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PJ Official ‚Äì Under Maintenance</title>

  <!-- EmailJS client (global) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body style="margin:0;min-height:100vh;background:#000;color:#fff;font-family:Arial, Helvetica, sans-serif;display:flex;align-items:center;justify-content:center;text-align:center;">

  <div style="width:380px;padding:26px;position:relative;">

    <!-- animated gears -->
    <div style="position:relative;height:120px;margin-bottom:22px;">
      <div class="gear big">‚öôÔ∏è</div>
      <div class="gear mid">‚öôÔ∏è</div>
      <div class="gear small">‚öôÔ∏è</div>
    </div>

    <h2 style="margin:0 0 8px 0">PJ official website is under update</h2>
    <p style="color:#bdbdbd;font-size:14px;margin:0 0 18px 0">Enter your email to get notified once the website is live.</p>

    <!-- Email input (users) -->
    <input id="emailInput" type="text" placeholder="Enter your email (example: someone@example.com)" 
      style="width:100%;padding:12px;border-radius:8px;border:none;outline:none;font-size:14px;background:#111;color:#fff;" />

    <!-- Password input (admins) -->
    <input id="passwordInput" type="password" placeholder="Admin password (for admin access)"
      style="width:100%;padding:12px;border-radius:8px;border:none;outline:none;font-size:14px;background:#111;color:#fff;margin-top:10px;" />

    <button id="continueBtn" style="margin-top:16px;width:100%;padding:12px;border:none;border-radius:30px;background:#ff7a00;color:#000;font-weight:700;cursor:pointer;font-size:14px;">
      Continue
    </button>

    <p id="userMsg" style="font-size:13px;margin-top:12px;color:#ccc;min-height:18px;"></p>

    <!-- ADMIN PANEL (hidden by default) -->
    <div id="adminPanel" style="display:none;margin-top:20px;text-align:center;">
      <div style="display:flex;align-items:center;gap:10px;justify-content:flex-start;">
        <button id="backBtn" title="Back" style="background:transparent;border:none;color:#fff;font-size:20px;cursor:pointer;padding:6px 0;margin-right:auto;">‚Üê</button>
        <div style="flex:1"></div>
      </div>

      <h3 style="color:#ff7a00;margin:10px 0 6px 0;">Admin Panel</h3>
      <p style="color:#bdbdbd;font-size:13px;margin:0 0 12px 0;">Click <strong>DONE</strong> to send the update email to all saved accounts.</p>

      <button id="doneBtn" style="margin-top:8px;width:100%;padding:12px;border:none;border-radius:30px;background:#ff7a00;color:#000;font-weight:700;cursor:pointer;font-size:14px;">
        DONE ‚Äî Send Update Email
      </button>

      <p id="adminStatus" style="font-size:13px;margin-top:12px;color:#ccc;min-height:18px;"></p>
    </div>

  </div>

<script type="module">
/*
  Robust handler:
  - wait for DOMContentLoaded
  - ensure EmailJS global is available (retry a bit)
  - initialize emailjs
  - register listeners
  - provide clear console logs and UI messages
*/

import { db } from "./firebase.js";
import {
  collection,
  addDoc,
  getDocs,
  query,
  where,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const ADMIN_PASSWORD = "sonu@jeet";
const EMAILJS_PUBLIC_KEY = "EevqJ2-cX2wrZXXJO";
const EMAILJS_SERVICE = "service_4mpzhc6";
const EMAILJS_TEMPLATE = "template_b2flto4";

function log(...args){ console.log("[pj]", ...args); }
function showMsg(text, color="#ccc"){
  const el = document.getElementById("userMsg");
  el.innerText = text;
  el.style.color = color;
}
function showAdminStatus(text, color="#ccc"){
  const el = document.getElementById("adminStatus");
  el.innerText = text;
  el.style.color = color;
}

function isLikelyEmail(s){
  if(!s) return false;
  return s.trim().toLowerCase().endsWith(".com");
}

// Wait for DOM ready
document.addEventListener("DOMContentLoaded", async () => {
  log("DOM ready");

  // Wait for EmailJS global to load (sometimes CDN is slow)
  let tries = 0;
  while (typeof window.emailjs === "undefined" && tries < 20) {
    await new Promise(res => setTimeout(res, 100));
    tries++;
  }
  if (typeof window.emailjs === "undefined") {
    log("EmailJS global not available - email sending will fail. Check network.");
    showMsg("Email service unavailable right now.", "red");
  } else {
    // initialize EmailJS once
    try {
      window.emailjs.init(EMAILJS_PUBLIC_KEY);
      log("EmailJS initialized");
    } catch(e){
      console.error("EmailJS init error", e);
      showMsg("Email service init failed.", "red");
    }
  }

  const emailInput = document.getElementById("emailInput");
  const passwordInput = document.getElementById("passwordInput");
  const continueBtn = document.getElementById("continueBtn");
  const userMsg = document.getElementById("userMsg");
  const adminPanel = document.getElementById("adminPanel");
  const doneBtn = document.getElementById("doneBtn");
  const backBtn = document.getElementById("backBtn");

  continueBtn.addEventListener("click", async () => {
    showMsg("");
    const emailVal = emailInput.value.trim();
    const passVal = passwordInput.value.trim();

    // ADMIN FLOW (password entered)
    if (passVal.length > 0) {
      if (passVal === ADMIN_PASSWORD) {
        adminPanel.style.display = "block";
        showMsg("Admin access granted", "#00ff99");
        emailInput.value = "";
        passwordInput.value = "";
        log("Admin unlocked");
      } else {
        showMsg("Wrong admin password", "red");
        log("Admin password wrong");
      }
      return;
    }

    // NORMAL USER FLOW
    if (!isLikelyEmail(emailVal)) {
      showMsg("Enter a valid email that ends with .com", "orange");
      log("Invalid email attempted:", emailVal);
      return;
    }

    try {
      // duplicate check
      const q = query(collection(db, "notifyEmails"), where("email", "==", emailVal));
      const snap = await getDocs(q);

      if (!snap.empty) {
        showMsg("This email is already registered", "orange");
        log("Duplicate email skip:", emailVal);
        return;
      }

      // save to Firestore
      await addDoc(collection(db, "notifyEmails"), {
        email: emailVal,
        notified: false,
        createdAt: Date.now()
      });

      // optional immediate confirmation email to the user (using EmailJS)
      if (typeof window.emailjs !== "undefined") {
        try {
          await window.emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, { to_email: emailVal });
          log("Confirmation email sent to", emailVal);
        } catch(e){
          console.warn("Confirmation email failed for", emailVal, e);
          // still consider save successful
        }
      }

      showMsg("Email saved successfully. We'll notify you when live.", "#00ff99");
      emailInput.value = "";

    } catch (err) {
      console.error("Save email failed:", err);
      showMsg("Unable to save email right now. Try again.", "red");
    }
  });

  // BACK BUTTON hides admin panel
  backBtn.addEventListener("click", () => {
    adminPanel.style.display = "none";
    showMsg("Returned from admin panel", "#ccc");
    showAdminStatus("", "#ccc");
    log("Admin panel hidden");
  });

  // DONE: send to all unnotified users
  doneBtn.addEventListener("click", async () => {
    showAdminStatus("Preparing to send emails...", "#ccc");
    log("Admin started send");

    try {
      const snap = await getDocs(collection(db, "notifyEmails"));
      let sentCount = 0;

      function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

for (const d of snap.docs) {
  const data = d.data();

  // agar pehle se notify ho chuka hai to skip
  if (data.notified === true) continue;

  await emailjs.send(
    "service_4mpzhc6",
    "template_b2flto4",
    { to_email: data.email }
  );

  // optional: agar tum flag use kar rahe ho
  // await updateDoc(doc(db, "notifyEmails", d.id), {
  //   notified: true
  // });

  // üî¥ YAHI MAIN FIX HAI
  await sleep(2000); // 2 second gap
}

        try {
          await window.emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, { to_email: data.email });
          await updateDoc(doc(db, "notifyEmails", d.id), { notified: true });
          sentCount++;
          log("Sent to:", data.email);
        } catch (sendErr) {
          console.error("Failed to send to", data.email, sendErr);
          // continue but don't mark notified
        }
      }

      showAdminStatus(`Completed. ${sentCount} emails sent.`, "#00ff99");
      log("Admin send completed. count:", sentCount);

    } catch (err) {
      console.error("Error sending update emails:", err);
      showAdminStatus("Error sending emails ‚Äî check console or EmailJS settings.", "red");
    }
  });

}); // DOMContentLoaded end
</script>

<style>
/* gears styling & animation */
.gear { position:absolute; color:#ff7a00; display:flex; align-items:center; justify-content:center; }
.big { font-size:88px; left:50%; top:50%; transform:translate(-50%,-50%); animation:spin 5s linear infinite; }
.mid { font-size:56px; left:68%; top:36%; animation:spinReverse 3s linear infinite; }
.small { font-size:36px; left:34%; top:30%; animation:spin 2s linear infinite; }

@keyframes spin { from { transform:translate(-50%,-50%) rotate(0deg); } to { transform:translate(-50%,-50%) rotate(360deg); } }
@keyframes spinReverse { from { transform:rotate(360deg);} to { transform:rotate(0);} }

input { box-sizing:border-box; }
@media (max-width:420px) {
  body > div { width:92% !important; }
}
</style>
</body>
</html>
